<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>后端控制面板</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h2, h3 { color: #333; }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="number"], input[type="file"], textarea, select {
            width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;
        }
        button {
            background-color: #5cb85c; color: white; padding: 10px 15px; border: none;
            border-radius: 4px; cursor: pointer; font-size: 16px;
        }
        button:hover { background-color: #4cae4c; }
        #videoFrame { border: 1px solid black; width: 320px; height: 240px; display: block; margin-top: 10px; background-color: #333; object-fit: contain; }
        .log { background-color: #272822; color: #f8f8f2; padding: 10px; border-radius: 4px; height: 200px; overflow-y: scroll; font-family: monospace; font-size: 0.85em; line-height: 1.3; }
        .client-list { margin-bottom: 10px;}
        #asrPreviewLog { min-height: 50px; background-color: #e0e0f0; color: #333; border: 1px solid #c0c0d0; white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body>
    <div class="container">
        <h2>后端控制与监控面板</h2>
        <div style="margin-bottom: 20px;">
            <a href="/management" style="text-decoration: none; padding: 8px 12px; background-color: #17a2b8; color: white; border-radius: 5px;">&#9881; 前往文件命名管理</a>
        </div>

        <div class="section client-list">
            <h3>连接的Android客户端</h3>
            <select id="clientSidSelect">
                <option value="">--等待客户端连接--</option>
            </select>
            <p>当前目标客户端: <strong id="targetSidDisplay">无</strong></p>
        </div>

        <div class="section">
            <h3>视频流预览 (来自选定客户端)</h3>
            <img id="videoFrame" src="" alt="视频帧区域">
            <p>音频数据: <span id="audioStatus">等待音频...</span></p>
        </div>

        <div class="section">
            <h3>实时ASR预览 (来自选定客户端)</h3>
            <div id="asrPreviewLog" class="log" style="height: 100px;" data-is-initial="true">等待ASR数据...</div>
        </div>

        <div class="section">
            <h3>发送指令到目标客户端</h3>
            <div>
                <h4>播放音频</h4>
                <label for="audioFile">选择MP3文件:</label>
                <input type="file" id="audioFile" accept=".mp3"><br>
                <label for="audioTypeIdentifier">音频类型标识 (可选, 如 welcome_msg):</label>
                <input type="text" id="audioTypeIdentifier" value="generic_audio"><br>
                <button onclick="sendPlayAudio()">发送播放音频指令</button>
            </div>
            <hr>
            <div>
                <h4>绘制方框</h4>
                <label for="boxId">方框ID (唯一, 如 box_face_1):</label>
                <input type="text" id="boxId" value="box_001"><br>
                <label for="rectNormalized">归一化坐标 [左,上,右,下] (逗号分隔, 0.0-1.0):</label>
                <input type="text" id="rectNormalized" value="0.1,0.1,0.9,0.9"><br>
                <label for="boxColor">颜色 [R,G,B,A] (逗号分隔, 0-255):</label>
                <input type="text" id="boxColor" value="255,0,0,255"><br>
                <label for="strokeWidth">线宽 (dp):</label>
                <input type="number" id="strokeWidth" value="2"><br>
                <label for="boxDuration">显示时长 (ms, 0为永久):</label>
                <input type="number" id="boxDuration" value="5000"><br>
                <button onclick="sendDrawBox()">发送绘制方框指令</button>
            </div>
            <hr>
            <div>
                <h4>显示文字</h4>
                <label for="textId">文字ID (唯一, 如 text_info_1):</label>
                <input type="text" id="textId" value="text_001"><br>
                <label for="textDisplay">显示内容:</label>
                <textarea id="textDisplay">你好，世界！</textarea><br>
                <label for="textPosition">归一化中心坐标 [X,Y] (逗号分隔, 0.0-1.0):</label>
                <input type="text" id="textPosition" value="0.5,0.5"><br>
                <label for="textColor">颜色 [R,G,B,A] (逗号分隔, 0-255):</label>
                <input type="text" id="textColor" value="0,0,255,255"><br>
                <label for="textSize">文字大小 (sp):</label>
                <input type="number" id="textSize" value="20"><br>
                <label for="textDuration">显示时长 (ms, 0为永久):</label>
                <input type="number" id="textDuration" value="5000"><br>
                <button onclick="sendDrawText()">发送显示文字指令</button>
            </div>
        </div>
         <div class="section">
            <h3>服务器与GUI交互日志</h3>
            <div id="serverLog" class="log"></div>
        </div>
    </div>

    <script>
        const socket = io({ transports: ['websocket'] });
        const videoFrameImg = document.getElementById('videoFrame');
        const audioStatusSpan = document.getElementById('audioStatus');
        const serverLogDiv = document.getElementById('serverLog');
        const clientSidSelectEl = document.getElementById('clientSidSelect');
        const targetSidDisplayEl = document.getElementById('targetSidDisplay');
        const asrPreviewLogDiv = document.getElementById('asrPreviewLog');
        let currentTargetSid = clientSidSelectEl.value || null;

        function logToGui(message) {
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${time}] ${message}`;
            serverLogDiv.appendChild(logEntry);
            serverLogDiv.scrollTop = serverLogDiv.scrollHeight;
        }

        clientSidSelectEl.addEventListener('change', function() {
            currentTargetSid = this.value;
            if (currentTargetSid) {
                targetSidDisplayEl.textContent = currentTargetSid;
                logToGui(`GUI: 目标客户端已更改为: ${currentTargetSid}`);
                videoFrameImg.src = "";
                audioStatusSpan.textContent = "等待新目标客户端数据...";
                asrPreviewLogDiv.innerHTML = `等待 ${currentTargetSid} 的ASR数据...`;
                asrPreviewLogDiv.dataset.isInitial = "true"; // MODIFIED
            } else {
                targetSidDisplayEl.textContent = '无 (请选择客户端)';
                logToGui(`GUI: 已取消选择目标客户端.`);
                videoFrameImg.src = "";
                audioStatusSpan.textContent = "无目标客户端被选择.";
                asrPreviewLogDiv.innerHTML = '请选择一个客户端以查看其ASR预览。';
                asrPreviewLogDiv.dataset.isInitial = "true"; // MODIFIED
            }
        });

        socket.on('connect', () => {
            logToGui('GUI: 已连接到服务器 (Socket.IO)');
        });

        socket.on('connect_error', (err) => {
            logToGui(`GUI: 连接错误! ${err.message} (Data: ${JSON.stringify(err.data)})`);
        });

        socket.on('disconnect', (reason) => {
            logToGui(`GUI: 已从服务器断开 (Socket.IO). 原因: ${reason}`);
        });

        socket.on('error', (error) => {
            logToGui(`GUI: Socket.IO 错误: ${error}`);
        });

        socket.on('server_log', (data) => {
            logToGui(`SERVER: ${data.message}`);
        });

        socket.on('update_client_list', (clients) => {
            const selectedValueBeforeUpdate = clientSidSelectEl.value;

            clientSidSelectEl.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.text = clients.length > 0 ? "--选择一个目标Android客户端--" : "--等待Android客户端连接--";
            clientSidSelectEl.appendChild(defaultOption);

            clients.forEach(clientIdString => {
                const option = document.createElement('option');
                option.value = clientIdString;
                option.text = clientIdString;
                clientSidSelectEl.appendChild(option);
            });

            if (clients.includes(selectedValueBeforeUpdate)) {
                clientSidSelectEl.value = selectedValueBeforeUpdate;
            } else if (clients.length > 0) {
                clientSidSelectEl.value = clients[0]; // Default to first client if previous selection gone
            } else {
                clientSidSelectEl.value = "";
            }
            
            // Trigger change event to update display and ASR log placeholder
            clientSidSelectEl.dispatchEvent(new Event('change'));
        });

        socket.on('decoded_video_frame', (data) => {
            if (data.sid === currentTargetSid && data.frame) {
                videoFrameImg.src = `data:image/jpeg;base64,${data.frame}`;
            }
        });

        socket.on('decoded_audio_status', (data) => {
             if (data.sid === currentTargetSid) {
                audioStatusSpan.textContent = `收到 ${data.length} 字节音频数据 از ${data.sid}, 时间戳: ${data.timestamp}`;
             }
        });

        // --- MODIFIED: 处理ASR更新事件，支持多行显示并追加内容 ---
        socket.on('asr_update', (data) => {
            if (data.sid === currentTargetSid) {
                const time = new Date().toLocaleTimeString();
                const formattedText = data.text.replace(/\n/g, '<br>');
                const logEntry = document.createElement('div');
                logEntry.innerHTML = `[${time}] ${formattedText}`; // innerHTML to render <br>

                if (asrPreviewLogDiv.dataset.isInitial === "true") {
                    asrPreviewLogDiv.innerHTML = ""; // Clear "等待..." message
                    asrPreviewLogDiv.dataset.isInitial = "false";
                }

                asrPreviewLogDiv.appendChild(logEntry);
                asrPreviewLogDiv.scrollTop = asrPreviewLogDiv.scrollHeight;
            }
        });
        // --- END MODIFICATION ---


        function getSelectedSid() {
            if (!currentTargetSid || currentTargetSid === "") {
                alert("请先从下拉列表中选择一个目标Android客户端！");
                logToGui("GUI: 尝试发送指令但未选择目标客户端。");
                return null;
            }
            return currentTargetSid;
        }

        function sendPlayAudio() {
            const sid = getSelectedSid();
            if (!sid) return;

            const fileInput = document.getElementById('audioFile');
            const audioTypeId = document.getElementById('audioTypeIdentifier').value;
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const audio_data_base64 = e.target.result.split(',')[1];
                    const command = {
                        target_sid: sid,
                        type: "PLAY_AUDIO",
                        timestamp: new Date().toISOString(),
                        audio_type_id: audioTypeId || file.name,
                        audio_data: audio_data_base64
                    };
                    socket.emit('send_command_to_client', command);
                };
                reader.readAsDataURL(file);
            } else {
                alert("请选择一个MP3文件!");
                logToGui("GUI: 尝试发送播放音频但未选择文件。");
            }
        }

        function sendDrawBox() {
            const sid = getSelectedSid();
            if (!sid) return;
            try {
                const command = {
                    target_sid: sid,
                    type: "DRAW_BOX",
                    box_id: document.getElementById('boxId').value || `box_${Date.now()}`,
                    rect_normalized: document.getElementById('rectNormalized').value.split(',').map(s => parseFloat(s.trim())),
                    color_rgba: document.getElementById('boxColor').value.split(',').map(s => parseInt(s.trim())),
                    stroke_width_dp: parseFloat(document.getElementById('strokeWidth').value),
                    duration_ms: parseInt(document.getElementById('boxDuration').value)
                };
                if (command.rect_normalized.length !== 4 || command.rect_normalized.some(isNaN)) throw new Error("方框坐标格式错误 (需要4个数字)");
                if (command.color_rgba.length !== 4 || command.color_rgba.some(isNaN)) throw new Error("方框颜色格式错误 (需要4个0-255的数字)");
                if (isNaN(command.stroke_width_dp) || isNaN(command.duration_ms)) throw new Error("线宽或时长必须是数字");

                socket.emit('send_command_to_client', command);
            } catch (e) {
                alert(`输入错误: ${e.message}`);
                logToGui(`GUI: 绘制方框指令输入错误 - ${e.message}`);
            }
        }

        function sendDrawText() {
            const sid = getSelectedSid();
            if (!sid) return;
            try {
                const command = {
                    target_sid: sid,
                    type: "DRAW_TEXT",
                    text_id: document.getElementById('textId').value || `text_${Date.now()}`,
                    text: document.getElementById('textDisplay').value,
                    position_normalized: document.getElementById('textPosition').value.split(',').map(s => parseFloat(s.trim())),
                    color_rgba: document.getElementById('textColor').value.split(',').map(s => parseInt(s.trim())),
                    size_sp: parseFloat(document.getElementById('textSize').value),
                    duration_ms: parseInt(document.getElementById('textDuration').value)
                };
                if (command.position_normalized.length !== 2 || command.position_normalized.some(isNaN)) throw new Error("文字位置坐标格式错误 (需要2个数字)");
                if (command.color_rgba.length !== 4 || command.color_rgba.some(isNaN)) throw new Error("文字颜色格式错误 (需要4个0-255的数字)");
                if (!command.text.trim()) throw new Error("显示内容不能为空");
                if (isNaN(command.size_sp) || isNaN(command.duration_ms)) throw new Error("文字大小或时长必须是数字");

                socket.emit('send_command_to_client', command);
            } catch (e) {
                alert(`输入错误: ${e.message}`);
                logToGui(`GUI: 显示文字指令输入错误 - ${e.message}`);
            }
        }

        // 初始化目标客户端显示和ASR预览区
        // Trigger change event on load to set initial state correctly based on select element
        clientSidSelectEl.dispatchEvent(new Event('change'));
        logToGui("GUI: 控制面板脚本已加载并初始化。");

    </script>
</body>
</html>